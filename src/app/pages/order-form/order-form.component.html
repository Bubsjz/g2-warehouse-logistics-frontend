<section class="container mt-4">
  <div class="card shadow-lg p-4">
    <h3 class="text-center my-4">
      {{ mode === 'create' ? 'Create Order' : mode === 'edit' ? 'Edit Order' : 'Review Order' }}
    </h3>
    <hr />
    <form (ngSubmit)="mode === 'review' ? submitReview() : saveDelivery()" #orderForm="ngForm">
      <!-- Mostrar mensaje de error -->
      <div *ngIf="submitted && errorMessage" class="alert alert-danger">
        {{ errorMessage }}
      </div>

      <!-- Fecha de envío -->
      <div class="my-3">
        <label class="form-label" for="send-date">Send Date</label>
        <input
          class="form-control rounded-pill"
          type="date"
          id="send-date"
          [ngModel]="delivery.send_date ? formatDateForInput(delivery.send_date) : ''"
          (ngModelChange)="onDateChange('send_date', $event)"
          name="send_date"
          [disabled]="!isEditable"
          required
        />
        <div *ngIf="submitted && !delivery.send_date" class="text-danger">
          Send date is required.
        </div>
      </div>

      <!-- Fecha de recepción -->
      <div class="my-3">
        <label class="form-label" for="received-date">Received Date</label>
        <input
          class="form-control rounded-pill"
          type="date"
          id="received-date"
          [ngModel]="delivery.received_date ? formatDateForInput(delivery.received_date) : ''"
          (ngModelChange)="onDateChange('received_date', $event)"
          name="received_date"
          [disabled]="!isEditable"
          required
        />
        <div *ngIf="submitted && !delivery.received_date" class="text-danger">
          Received date is required.
        </div>
      </div>

      <!-- Almacén de origen -->
      <div class="my-3">
        <label class="form-label" for="origin">Origin Warehouse</label>
        <select
          class="form-select rounded-pill"
          id="origin"
          [(ngModel)]="delivery.origin_warehouse_id"
          name="origin_warehouse_id"
          [disabled]="!isEditable"
          required
        >
          <option [ngValue]="null" disabled>Select the origin warehouse</option>
          <option *ngFor="let warehouse of warehouses" [value]="warehouse.id_warehouse">
            {{ warehouse.name }}
          </option>
        </select>
        <div *ngIf="orderForm.submitted && !orderForm.controls['origin_warehouse_id']?.valid" class="text-danger">
          Origin warehouse is required.
        </div>
      </div>

      <!-- Almacén de destino -->
      <div class="my-3">
        <label class="form-label" for="destination">Destination Warehouse</label>
        <select
          class="form-select rounded-pill"
          id="destination"
          [(ngModel)]="delivery.destination_warehouse_id"
          name="destination_warehouse_id"
          [disabled]="!isEditable"
          required
        >
          <option [ngValue]="null" disabled>Select the destination warehouse</option>
          <option *ngFor="let warehouse of warehouses" [value]="warehouse.id_warehouse">
            {{ warehouse.name }}
          </option>
        </select>
        <div *ngIf="orderForm.submitted && !orderForm.controls['destination_warehouse_id']?.valid" class="text-danger">
          Destination warehouse is required.
        </div>
      </div>

      <!-- Matrícula del camión -->
      <div class="my-3">
        <label class="form-label" for="truck">Truck License Plate</label>
        <select
          class="form-select rounded-pill"
          id="truck"
          [(ngModel)]="delivery.truck_id_truck"
          name="truck_id_truck"
          [disabled]="!isEditable"
          required
        >
          <option [ngValue]="null" disabled>Select the truck</option>
          <option *ngFor="let truck of trucks" [value]="truck.id_truck">
            {{ truck.plate }}
          </option>
        </select>
        <div *ngIf="orderForm.submitted && !orderForm.controls['truck_id_truck']?.valid" class="text-danger">
          Truck is required.
        </div>
      </div>

      <!-- Productos -->
        <p class="fw-bold mt-4">Order Details</p>
        <div *ngFor="let detail of orderDetails; let i = index" class="my-3 d-flex align-items-center gap-3">
        <!-- Selector de tipo de producto -->
        <select
          class="form-select rounded-pill w-50"
          [(ngModel)]="detail.product_id"
          name="product-{{ i }}"
          [ngModelOptions]="{ standalone: true }"
          [disabled]="!isEditable"
          (change)="detail.touched = true"
          required
        >
          <option [ngValue]="null" disabled>Select a product</option>
          <option *ngFor="let product of products" [value]="product.id_product">
            {{ product.name }}
          </option>
        </select>
        <!-- Validación -->
        <div *ngIf="detail.touched && !detail.product_id" class="text-danger">
          Product is required.
        </div>

        <!-- Campo de cantidad -->
        <input
          type="number"
          class="form-control rounded-pill w-25"
          placeholder="Quantity"
          [(ngModel)]="detail.quantity"
          name="quantity-{{ i }}"
          [ngModelOptions]="{ standalone: true }"
          [disabled]="!isEditable"
          min="1"
          (blur)="detail.touched = true"
          required
        />
        <!-- Validación -->
        <div *ngIf="detail.touched && (!detail.quantity || detail.quantity <= 0)" class="text-danger">
          Quantity must be greater than 0.
        </div>

        <!-- Botón para eliminar producto -->
        <button type="button" class="btn btn-danger" *ngIf="isEditable" (click)="removeProduct(i)">
          &minus;
        </button>
      </div>

      <!-- Botón para agregar nuevos productos -->
      <div class="my-3">
        <button type="button" class="btn btn-primary rounded-pill" *ngIf="isEditable" (click)="addProduct()">
          + Add Product
        </button>
      </div>

      <!-- Sección de comentarios solo visible en modo edit y review -->
      <div class="my-3" *ngIf="mode !== 'create' && (delivery.status !== 'pending' || mode === 'review')">
        <label class="form-label" for="comments">Comments</label>
        <textarea
          class="form-control"
          id="comments"
          [(ngModel)]="delivery.comments"
          name="comments"
          [disabled]="!isCommentEditable"
          placeholder="No comments"
          rows="3"
        ></textarea>
      </div>

      <!-- Botones -->
      <div class="d-flex justify-content-center gap-2 my-4">
        <!-- Botones en modo create -->
        <ng-container *ngIf="mode === 'create' && areButtonsEnabled">
          <button
            type="button"
            class="btn btn-warning rounded-pill"
            (click)="saveAsDraft()"
          >
            Save as draft
          </button>
          <button
            type="submit"
            class="btn btn-success rounded-pill"
            [disabled]="!validateForm()"
          >
            Create Order
          </button>
        </ng-container>
      
        <!-- Botones en modo edit -->
        <ng-container *ngIf="mode === 'edit' && areButtonsEnabled">
          <button
            type="submit"
            class="btn btn-success rounded-pill"
            [disabled]="!validateForm()"
          >
            Create Order
          </button>
          <button
            type="button"
            class="btn btn-danger rounded-pill"
            (click)="deleteDelivery()"
          >
            Delete Order
          </button>
        </ng-container>
      
        <!-- Botones en modo review -->
        <ng-container *ngIf="mode === 'review' && areButtonsEnabled">
          <button
            class="btn btn-danger rounded-pill"
            type="button"
            (click)="submitReview()"
            [disabled]="!isCommentEditable || !delivery.comments || delivery.comments.trim() === ''"
          >
            Send Comments
          </button>
          <button
            class="btn btn-success rounded-pill"
            type="button"
            (click)="approveDelivery()"
          >
            Approve
          </button>
        </ng-container>
      
        <!-- Botón "Back" (siempre visible) -->
        <button
          type="button"
          class="btn btn-dark rounded-pill"
          (click)="cancel()"
        >
          Back
        </button>
      </div>
    </form>
  </div>
</section>


