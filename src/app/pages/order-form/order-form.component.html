<section class="container mt-4">
  <div class="card shadow-lg p-4">
    <h3 class="text-center my-4">
      {{ getTitle() }}
    </h3>
    <hr />
    <form (ngSubmit)="processModeSpecificActions(mode === 'review' ? 'submit' : 'save')" #orderForm="ngForm">
      <!-- Mostrar mensaje de error -->
      <div *ngIf="submitted && errorMessage" class="alert alert-danger">
        {{ errorMessage }}
      </div>

      <!-- Fecha de envío -->
      <div class="my-3">
        <label class="form-label" for="send-date">Send Date</label>
        <input
          class="form-control rounded-pill"
          type="date"
          id="send-date"
          [ngModel]="delivery.send_date ? formatDateForInput(delivery.send_date) : ''"
          (ngModelChange)="onDateChange('send_date', $event)"
          [ngClass]="{ 'is-invalid': submitted && !delivery.send_date }"
          name="send_date"
          [disabled]="mode === 'review' || !isEditable"
          required
        />
        <div *ngIf="submitted && !delivery.send_date" class="text-danger">
          Send date is required.
        </div>
      </div>

      <!-- Fecha de recepción -->
      <div class="my-3">
        <label class="form-label" for="received-date">Received Date</label>
        <input
          class="form-control rounded-pill"
          type="date"
          id="received-date"
          [ngModel]="delivery.received_date ? formatDateForInput(delivery.received_date) : ''"
          (ngModelChange)="onDateChange('received_date', $event)"
          [ngClass]="{ 'is-invalid': submitted && !delivery.received_date }"
          name="received_date"
          [disabled]="mode === 'review' || !isEditable"
          required
        />
        <div *ngIf="submitted && !delivery.received_date" class="text-danger">
          Received date is required.
        </div>
        <div *ngIf="delivery.send_date && delivery.received_date && delivery.received_date < delivery.send_date" class="text-danger">
          Received date cannot be earlier than send date.
        </div>
      </div>

      <!-- Almacén de origen -->
      <div class="my-3">
        <label class="form-label" for="originWarehouse">Origin Warehouse</label>
        <ng-container *ngIf="mode !== 'review'; else staticOriginWarehouse">
          <select
            class="form-select rounded-pill"
            [(ngModel)]="delivery.origin_warehouse_name"
            [ngClass]="{ 'is-invalid': submitted && !delivery.origin_warehouse_name }"
            name="origin_warehouse_name"
            id="originWarehouse"
            required
          >
            <option [ngValue]="null" disabled>Select the origin warehouse</option>
            <option *ngFor="let warehouse of warehouses" [value]="warehouse.name">
              {{ warehouse.name }}
            </option>
          </select>
          <div *ngIf="submitted && !delivery.origin_warehouse_name" class="text-danger">
            Origin warehouse is required.
          </div>
        </ng-container>
        <ng-template #staticOriginWarehouse>
          <span class="form-control rounded-pill">{{ delivery.origin_warehouse_name || 'N/A' }}</span>
        </ng-template>
      </div>

      <!-- Almacén de destino -->
      <div class="my-3">
        <label class="form-label" for="destinationWarehouse">Destination Warehouse</label>
        <ng-container *ngIf="mode !== 'review'; else staticDestinationWarehouse">
          <select
            class="form-select rounded-pill"
            [(ngModel)]="delivery.destination_warehouse_name"
            [ngClass]="{ 'is-invalid': submitted && !delivery.destination_warehouse_name }"
            name="destination_warehouse_name"
            id="destinationWarehouse"
            required
          >
            <option [ngValue]="null" disabled>Select the destination warehouse</option>
            <option *ngFor="let warehouse of warehouses" [value]="warehouse.name">
              {{ warehouse.name }}
            </option>
          </select>
          <div *ngIf="submitted && !delivery.destination_warehouse_name" class="text-danger">
            Destination warehouse is required.
          </div>
          <div *ngIf="delivery.origin_warehouse_name && delivery.destination_warehouse_name && delivery.origin_warehouse_name === delivery.destination_warehouse_name" class="text-danger">
            Origin and destination warehouses must be different.
          </div>
        </ng-container>
        <ng-template #staticDestinationWarehouse>
          <span class="form-control rounded-pill">{{ delivery.destination_warehouse_name || 'N/A' }}</span>
        </ng-template>
      </div>

      <!-- Matrícula del camión -->
      <div class="my-3">
        <label class="form-label" for="plate">Truck License Plate</label>
        <ng-container *ngIf="mode !== 'review'; else staticPlate">
          <select
            class="form-select rounded-pill"
            [(ngModel)]="delivery.plate"
            [ngClass]="{ 'is-invalid': submitted && !delivery.plate }"
            name="truck_plate"
            id="plate"
            required
          >
            <option [ngValue]="null" disabled>Select the truck plate</option>
            <option *ngFor="let truck of trucks" [value]="truck.plate">
              {{ truck.plate }}
            </option>
          </select>
          <div *ngIf="submitted && !delivery.plate" class="text-danger">
            Truck is required.
          </div>
        </ng-container>
        <ng-template #staticPlate>
          <span class="form-control rounded-pill">{{ delivery.plate || 'N/A' }}</span>
        </ng-template>
      </div>

      <!-- Productos -->
        <p class="fw-bold mt-4">Order Products</p>
        <div *ngIf="orderDetails.length === 0 && mode === 'review'" class="alert alert-warning">
          There are no products associated with this order.
        </div>
        <div *ngFor="let detail of orderDetails; let i = index" class="my-3 d-flex align-items-center gap-3">
        <!-- Selector de tipo de producto -->
        <ng-container *ngIf="mode === 'edit'; else staticProduct">
          <select
            class="form-select rounded-pill w-50"
            [(ngModel)]="detail.product_name"
            [ngClass]="{ 'is-invalid': submitted && !detail.product_name }"
            name="product-{{ i }}"
            id="product{{ i }}"
            [ngModelOptions]="{ standalone: true }"
            required
          >
            <option [ngValue]="null" disabled>Select a product</option>
            <option *ngFor="let product of products" [value]="product.name">
              {{ product.name }}
            </option>
          </select>
                  <!-- Validación -->
        <div *ngIf="detail.touched && !detail.product_name" class="text-danger">
          Product is required.
        </div>
        </ng-container>
        <ng-template #staticProduct>
          <span class="form-control rounded-pill w-50">{{ detail.product_name || 'N/A' }}</span>
        </ng-template>


        <!-- Campo de cantidad -->
          <div>
            <ng-container *ngIf="mode === 'edit' || mode === 'create'; else staticQuantity">
              <input
                type="number"
                class="form-control rounded-pill w-25"
                placeholder="Quantity"
                [(ngModel)]="detail.product_quantity"
                [ngClass]="{ 'is-invalid': submitted && !detail.product_quantity }"
                name="quantity-{{ i }}"
                id="quantity{{ i }}"
                [ngModelOptions]="{ standalone: true }"
                min="1"
                required
              />
              <!-- Validación -->
              <div *ngIf="detail.touched && (!detail.product_quantity || detail.product_quantity <= 0)" class="text-danger">
                Quantity must be greater than 0.
              </div>
            </ng-container>
            <ng-template #staticQuantity>
              <span class="form-control rounded-pill w-4">{{ detail.product_quantity || '0' }}</span>
            </ng-template>
          </div>

        <!-- Botón para eliminar producto -->
        <button type="button" class="btn btn-danger" *ngIf="canManageProducts" (click)="removeProduct(i)">
          &minus;
        </button>
      </div>

      <!-- Botón para agregar nuevos productos -->
      <div class="my-3">
        <button type="button" class="btn btn-primary rounded-pill" *ngIf="canManageProducts" (click)="addProduct()">
          + Add Product
        </button>
      </div>

      <!-- Sección de comentarios solo visible en modo edit y review -->
      <div class="my-3" *ngIf="mode !== 'create' && (delivery.status !== 'pending' || mode === 'review')">
        <label class="form-label" for="comments">Comments</label>
        <textarea
          class="form-control"
          id="comments"
          [(ngModel)]="delivery.comments"
          name="comments"
          [disabled]="!isCommentEditable"
          placeholder="No comments"
          rows="3"
        ></textarea>
      </div>

      <!-- Botones -->
      <div class="d-flex justify-content-center gap-2 my-4">
        <!-- Botones en modo create -->
        <ng-container *ngIf="mode === 'create' && areButtonsEnabled">
          <button
            type="button"
            class="btn btn-warning rounded-pill"
            (click)="processModeSpecificActions('save', 'pending')"
          >
            Save as draft
          </button>
          <button
            type="submit"
            class="btn btn-success rounded-pill"
            [disabled]="!validateForm()"
            (click)="processModeSpecificActions('save', 'review')"
          >
            Create Order
          </button>
        </ng-container>
      
        <!-- Botones en modo edit -->
        <ng-container *ngIf="mode === 'edit' && areButtonsEnabled">
          <button
            type="submit"
            class="btn btn-success rounded-pill"
            [disabled]="!validateForm()"
            (click)="processModeSpecificActions('update', 'review')"
          >
          {{ delivery.status === 'pending' ? 'Create Order' : 'Update Order' }}
          </button>
          <button
            type="button"
            class="btn btn-danger rounded-pill"
            (click)="deleteDelivery()"
          >
            Delete Order
          </button>
        </ng-container>
      
        <!-- Botones en modo review -->
        <ng-container *ngIf="mode === 'review' && areButtonsEnabled">
          <button
            class="btn btn-danger rounded-pill"
            type="button"
            (click)="handleReviewAction('submit')"
            [disabled]="!isCommentEditable || !delivery.comments || delivery.comments.trim() === ''"
          >
          {{ delivery.status === 'review' ? 'Send comments' : 'Not approved' }}
          </button>
          <button
            class="btn btn-success rounded-pill"
            type="button"
            (click)="handleReviewAction('approve')"
          >
          {{ delivery.status === 'review' ? 'Send delivery' : 'Approved' }}
          </button>
<!--           <button
            class="btn btn-danger rounded-pill"
            type="button"
            (click)="handleReviewAction('reject')"
            *ngIf="delivery.status === 'pending reception'"
          >
            Reject
          </button> -->
        </ng-container>
      
        <!-- Botón "Back" (siempre visible) -->
        <button
          type="button"
          class="btn btn-dark rounded-pill"
          (click)="cancel()"
        >
          Back
        </button>
      </div>
    </form>
  </div>
</section>


